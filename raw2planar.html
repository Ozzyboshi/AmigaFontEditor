<!DOCTYPE HTML>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/AmigaFontEditor.css">
	<script src="js/AmigaFontEditor.js"></script>
	<script src="js/UPNG.js"></script>
	<script src="js/pako.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/4.2.2/math.min.js"></script>
  </head>
  <body>
	<a href="https://github.com/Ozzyboshi/AmigaFontEditor"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

	<div class="topnav">
	  <a href="index.html">Fonts</a>
	  <a href="index_sprite.html">Sprite</a>
	  <a href="index_sprite_position.html">Sprite position</a>
	  <a href="register_conversion.html">Register conversion</a>
	  <a href="copperlist_translator.html">Copperlist translator</a>
	  <a href="diwstartstop.html">Diwstart/stop</a>
	  <a href="projection.html">Point Projection</a>
	  <a href="trigonometry.html">Trigonometric tables</a>
	  <a class="active" href="#">Raw 2 planar viewer</a>
	</div>

	<div id="content" style="padding:25px">
		<h2>Raw 2 planar viewer</h2>
		<p style="white-space: pre-line;">Upload here your raw file containing bitplanes data.
			Each bitplane must be Lowpal Res (320X256) not interleaved.
			After loading you should see which pixel are turned on into the Amiga planar screen</p>
		<input type="button" class="hideshowcontrols" value="Hide Controls">
        <input type="button" value="Import From Raw File" onclick="document.getElementById('fileChooser').click();" />
		<input type="button" value="Clear all squares" onclick="clearAllSquares();" />

		<div id="colorpalette" draggable="false" >
			<input type="file" id="fileChooser" style="display:none;">
			<input id="nbitplanes" type="range" min="1" max="5" step="1"/><a id="bitplaneslabel">Bitplanes :2</a>
			<ul id="colorslist">
				<li idcolor="0"><input type=color id="color0" value="#EEE8AA">Color 00</li>
				<li idcolor="1"><input type=color id="color1" value="#ff0000">Color 01</li>
				<li idcolor="2"><input type=color id="color2" value="#00ff00">Color 02</li>
				<li idcolor="3"><input type=color id="color3" value="#0000ff">Color 03</li>
				<li idcolor="4"><input type=color id="color4" value="#000000">Color 04</li>
				<li idcolor="5"><input type=color id="color5" value="#ff00ff">Color 05</li>
				<li idcolor="6"><input type=color id="color6" value="#ff00ff">Color 06</li>
				<li idcolor="7"><input type=color id="color7" value="#ff00ff">Color 07</li>
				<li idcolor="8"><input type=color id="color8" value="#ff00ff">Color 08</li>
				<li idcolor="9"><input type=color id="color9" value="#ff00ff">Color 09</li>
				<li idcolor="10"><input type=color id="color10" value="#ff00ff">Color 10</li>
				<li idcolor="11"><input type=color id="color11" value="#ff00ff">Color 11</li>
				<li idcolor="12"><input type=color id="color12" value="#ff00ff">Color 12</li>
				<li idcolor="13"><input type=color id="color13" value="#ff00ff">Color 13</li>
				<li idcolor="14"><input type=color id="color14" value="#ff00ff">Color 14</li>
				<li idcolor="15"><input type=color id="color15" value="#ff00ff">Color 15</li>
				<li idcolor="16"><input type=color id="color16" value="#ff00ff">Color 16</li>
				<li idcolor="17"><input type=color id="color17" value="#ff00ff">Color 17</li>
				<li idcolor="18"><input type=color id="color18" value="#ff00ff">Color 18</li>
				<li idcolor="19"><input type=color id="color19" value="#ff00ff">Color 19</li>
				<li idcolor="20"><input type=color id="color20" value="#ff00ff">Color 20</li>
				<li idcolor="21"><input type=color id="color21" value="#ff00ff">Color 21</li>
				<li idcolor="22"><input type=color id="color22" value="#ff00ff">Color 22</li>
				<li idcolor="23"><input type=color id="color23" value="#ff00ff">Color 23</li>
				<li idcolor="24"><input type=color id="color24" value="#ff00ff">Color 24</li>
				<li idcolor="25"><input type=color id="color25" value="#ff00ff">Color 25</li>
				<li idcolor="26"><input type=color id="color26" value="#ff00ff">Color 26</li>
				<li idcolor="27"><input type=color id="color27" value="#ff00ff">Color 27</li>
				<li idcolor="28"><input type=color id="color28" value="#ff00ff">Color 28</li>
				<li idcolor="29"><input type=color id="color29" value="#ff00ff">Color 29</li>
				<li idcolor="30"><input type=color id="color30" value="#ff00ff">Color 30</li>
				<li idcolor="31"><input type=color id="color31" value="#ff00ff">Color 31</li>
			</ul>
			<pre id=pospre>
			X: 0
			Y: 0
			</pre>
		</div>
		<div id=result style="display:none;">
			<textarea id="resultpre"></textarea>
			<input type=button id=copyresult value="Copy to Clipboard" />
			<input type="button" class="hideshowcontrols" value="Hide Controls">
            <input type=button id=calculate value="Generate Raw File" />


		</div>
		<ul id="fonttable"></ul>
	</div>
    <script>
	var NBITPLANES=2; // The program starts with 2 bitplane
	var NUMPALETTECOLORS=32; // Amiga internal registers manage up to 32 colors from DFF180 (color 00 to DFF1BE color 31)
	var SQUARE_PIXELS = 5; // Pixel needed to draw a square
	var PIXEL_RESOLUTION=[320,256];
	var XCOORDINATES=[];
	var YCOORDINATES=[];

	  for (i=0;i<NUMPALETTECOLORS;i++)
	  {
	  	var liColor=document.querySelectorAll("#colorslist > li")[i];
	  	if (i<Math.pow(2,NBITPLANES))
	  		liColor.style = "display: show";
	  	else
	  		liColor.style = "display: none";
	  }
	  
	  // Manage palette change color
	  var palette = new FontColorsTable(NBITPLANES);

	  for (i=0;i<NUMPALETTECOLORS;i++)
	  {
	  	var colorObj=document.querySelectorAll("#colorslist > li > input[type=color]")[i];
	  	palette.addFont24BitHexColor(colorObj.value);

	  	colorObj.addEventListener('input',handleChangePaletteColor, false);
	  }
	  palette.setFgColorIndex(1);
	  palette.setBgColorIndex(0);

	  function handleChangePaletteColor(event) {
	  	palette.changeColor(parseInt(this.parentNode.getAttribute('idcolor')),this.value);
	  	table.updateColor(parseInt(this.parentNode.getAttribute('idcolor')),this.value);
	  }

	  // Manage color selection and palette creation
	  for (i=0;i<NUMPALETTECOLORS;i++)
	  {
	  	var fontLiObj=document.querySelectorAll("#colorslist > li")[i];
	  	fontLiObj.addEventListener('click',handleChangeColor, false);
	  }
	  function handleChangeColor(event) { 
	  for (i=0;i<NUMPALETTECOLORS;i++)
	  {
	  	document.querySelectorAll("#colorslist > li")[i].style.background='#9e9e9e';
	  }
	  palette.setFgColorIndex(this.getAttribute('idcolor'));
	  this.style.backgroundColor  = 'red';

	}

	//Create fonts table for characters from ascii 32 to 127
	var charset = [];
	for (var i = 48; i <= 48; i++) charset.push(i);
	//var spriteTable=createSpriteTable(charset,palette,{x:PIXEL_RESOLUTION[0],y: PIXEL_RESOLUTION[1]});
	//spriteTable.createList();
	var table=createMonitorTable(charset,palette,{x:PIXEL_RESOLUTION[0],y: PIXEL_RESOLUTION[1]}, function (square) {
		var xPos=parseInt(parseInt(square.x/2)+64);
		var yPos=parseInt(parseInt(square.y)+44);
		console.log(xPos+"-"+xPos.toString(16));
		console.log(yPos+"-"+yPos.toString(16));

		xPos=xPos<<1;
		if (square.x%2==1)
		{
			xPos=xPos|1;
		}

		XCOORDINATES.push("$"+xPos.toString(16));
		YCOORDINATES.push("$"+yPos.toString(16));

		updateResults();
	},function (square_selected) {
		document.getElementById('pospre').innerHTML='X : '+square_selected.x+'\nY : '+square_selected.y;
	});
	table.createList(document.getElementById("fonttable"));
	table.appendListToUl(document.getElementById('fontnavigator'));

	// Set change palette callback to update gui if palette changes
	table.setChangePaletteCallback(
		function (paletteArray) {
			for (var i=0;i<paletteArray.length;i++)
			{
				document.querySelectorAll("#colorslist > li > input[type=color]")[i].value=paletteArray[i];
				palette.setBgColorIndex(0);
				palette.setFgColorIndex(i);

				palette.changeColor(i,paletteArray[i]);
				table.updateColor(i,paletteArray[i]);
			}
		}
	);

	// Handle file export click
	var calculate = document.getElementById('calculate');
	calculate.onclick = function() {
		var binaryData=table.getBinaryData(palette.nBitplanes);
		//console.log(binaryData);
		var fileName = prompt("Please enter the name of your export file", "Myfonts.fnt");
		if (fileName)
			saveByteArray([binaryData], fileName);
	};

	var saveByteArray = (function () {
		var a = document.createElement("a");
		document.body.appendChild(a);
		a.style = "display: none";
		return function (data, name) {
		    var blob = new Blob(data, {type: "octet/stream"}),
		    url = window.URL.createObjectURL(blob);
		    a.href = url;
		    a.download = name;
		    a.click();
		    window.URL.revokeObjectURL(url);
		};
	}());

	document.querySelector("#fileChooser").addEventListener('change',filesChosen, false);
	function filesChosen(evt){
		var chosenFile = evt.target.files[0]; //get the first file in the FileList
		var fileName = chosenFile.name; //the name of the file as a string
		var fileSize = chosenFile.size; //the size of the file in bytes, as an integer
		var fileModifiedDate = chosenFile.lastModifiedDate; //a Date object
		//console.log(chosenFile);
		reader = new FileReader();
		//reader.addEventListener("load", readFile, false);
		reader.readAsArrayBuffer(document.querySelector("#fileChooser").files[0]);
		reader.onloadend = function () {
			table.drawRawImg(new Uint8Array(reader.result),2);
			alert('File loaded succesfully');
			document.getElementById('fileChooser').value = null;
			return ;
		}
	}

	
	document.querySelector("#copyresult").addEventListener('click',copyToClipboard,false);
	function copyToClipboard()
	{
		var ta = document.getElementById('resultpre');
		ta.focus();
		ta.select();
	}

	
	//document.querySelector(".hideshowcontrols").addEventListener('click',hideshowcontrols,false);
	var classname = document.getElementsByClassName("hideshowcontrols");
	for (var i = 0; i < classname.length; i++) {
    	classname[i].addEventListener('click', hideshowcontrols, false);
	}
	function hideshowcontrols()
	{
		if (this.value=="Hide Controls")
		{
			document.querySelector(".hideshowcontrols").value="Show Controls";
			document.querySelector("#colorpalette").style.display = "none";
			return;
		}
		document.querySelector(".hideshowcontrols").value="Hide Controls";
		document.querySelector("#colorpalette").style.display = "block";
	}

	function updateResults()
	{

		for (var i=0;i<XCOORDINATES.length;i++)
		{
			var virgola="";
			if (i>0) virgola=",";
			if (i>0 && i%10==0) { document.getElementById("resultpre").innerHTML +='\n\tdc.w '; virgola="";}
			document.getElementById("resultpre").innerHTML += virgola+XCOORDINATES[i];
		}
		if (mirror)
		{
			document.getElementById("resultpre").innerHTML += '\nTABXMIRROR\n\tdc.w ';
			for (var i=0;i<XCOORDINATES.length;i++)
			{
				var virgola="";
				if (i>0) virgola=",";
				if (i>0 && i%10==0) { document.getElementById("resultpre").innerHTML +='\n\tdc.w '; virgola="";}
				document.getElementById("resultpre").innerHTML += virgola+XCOORDINATES[XCOORDINATES.length-1-i];
			}
		}
		document.getElementById("resultpre").innerHTML += '\nFINETABX';

		document.getElementById("resultpre").innerHTML += '\n\nTABY\n\tdc.w ';
		for (var i=0;i<YCOORDINATES.length;i++)
		{
			var virgola="";
			if (i>0) virgola=",";
			if (i>0 && i%10==0) { document.getElementById("resultpre").innerHTML +='\n\tdc.w '; virgola="";}
			document.getElementById("resultpre").innerHTML += virgola+YCOORDINATES[i];
			
		}
		if (mirror)
		{
			document.getElementById("resultpre").innerHTML += '\n\nTABYMIRROR\n\tdc.w ';
			for (var i=0;i<YCOORDINATES.length;i++)
			{
				var virgola="";
				if (i>0) virgola=",";
				if (i>0 && i%10==0) { document.getElementById("resultpre").innerHTML +='\n\tdc.w '; virgola="";}
				document.getElementById("resultpre").innerHTML += virgola+YCOORDINATES[YCOORDINATES.length-1-i];
			}
		}
		document.getElementById("resultpre").innerHTML += '\nFINETABY';
	}
	document.getElementById("colorpalette").addEventListener('dragover',dragfunction,false);
	function dragfunction (data)
	{
		console.log(data);
		 document.getElementById("colorpalette").style.left = data.screenX + 'px';
    	document.getElementById("colorpalette").style.top = data.screenY + 'px';
	}
	// Manage slider for changing bitplane numbers
	document.getElementById('nbitplanes').addEventListener('change',handleChangeBitplaneNumber,false);
	function handleChangeBitplaneNumber(event)
	{
		palette.changeBitplanes(this.value*1);
	  	
	  	// Hide out of range palettes
	  	for (i=0;i<NUMPALETTECOLORS;i++)
	  	{
	  		var liColor=document.querySelectorAll("#colorslist > li")[i];
	  		if (i<Math.pow(2,this.value*1))
	  			liColor.style = "display: show";
	  		else
	  			liColor.style = "display: none";
	  		var colorObj=document.querySelectorAll("#colorslist > li > input[type=color]")[i];
	  		palette.addFont24BitHexColorAtPos(colorObj.value,i);

	  	}

	  	//Bitplane label update
	  	document.getElementById('bitplaneslabel').innerHTML='Bitplanes :'+this.value;

	  	table.updatePalette(palette);
	  	palette.setFgColorIndex(1);
	  	palette.setBgColorIndex(0);
	}
	function clearAllSquares()
	{
		table.clearRawImg();
	}
    </script>
  </body>
</html>  
